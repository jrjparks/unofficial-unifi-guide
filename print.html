<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-65646403-2"></script>
        <script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());

              gtag('config', 'UA-65646403-2');
        </script>

        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The unofficial guide to UniFi</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Documenting my learning about the UniFi SDN">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded "><a href="protocols.html"><strong aria-hidden="true">2.</strong> Protocols</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="protocols/discovery.html"><strong aria-hidden="true">2.1.</strong> Discovery</a></li><li class="chapter-item expanded "><a href="protocols/inform.html"><strong aria-hidden="true">2.2.</strong> Inform</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="protocols/inform-json-payload.html"><strong aria-hidden="true">2.2.1.</strong> Inform JSON Payload</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="adoption.html"><strong aria-hidden="true">3.</strong> Adoption</a></li><li class="chapter-item expanded "><a href="config.html"><strong aria-hidden="true">4.</strong> Config</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="config/management.html"><strong aria-hidden="true">4.1.</strong> Management Config</a></li><li class="chapter-item expanded "><a href="config/system.html"><strong aria-hidden="true">4.2.</strong> System Config</a></li></ol></li><li class="chapter-item expanded "><a href="previous-works.html"><strong aria-hidden="true">5.</strong> Previous works of others</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The unofficial guide to UniFi</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="intro"><a class="header" href="#intro">Intro</a></h1>
<p>These are the mad writings of an lone engineer and not official documentation.</p>
<p>Here be dragons.</p>
<h2 id="what-is-this"><a class="header" href="#what-is-this">What is this?</a></h2>
<p>This book documents what I've observed and learned about UniFi and how the SDN works.
This book is based on and is a continuation of <a href="./previous-works.html">previous works of others</a>.
There is no set reading order for this book.</p>
<blockquote>
<p><strong>üí° Tip:</strong> You can search through this book by clicking on the üîç icon at the
top of the page, or by pressing the <code>s</code> key.</p>
</blockquote>
<h2 id="who-is-this-for"><a class="header" href="#who-is-this-for">Who is this for?</a></h2>
<p>This book is for anyone who is interested in how UniFi's SDN devices work.
You should be familiar with networking and some knowledge of data encryption and compression.</p>
<h2 id="contributing"><a class="header" href="#contributing">Contributing</a></h2>
<p>This book is open source! Find a typo? Was something overlooked? <a href="https://github.com/jrjparks/unofficial-unifi-guide"><strong>Send a pull request!</strong></a></p>
<h4 id="license"><a class="header" href="#license">License</a></h4>
<p>This book is released under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a></p>
<h1 id="protocols"><a class="header" href="#protocols">Protocols</a></h1>
<p>This section documents what I've learned about how the UniFi protocols are structured.</p>
<ul>
<li><a href="./protocols/discovery.html">Discovery</a></li>
<li><a href="./protocols/inform.html">Inform</a>
<ul>
<li><a href="./protocols/inform-json-payload.html">Inform JSON Payload</a></li>
</ul>
</li>
</ul>
<h1 id="discovery-protocol"><a class="header" href="#discovery-protocol">Discovery Protocol</a></h1>
<p>A factory reset UniFi device will send discovery packets as multicast to <code>233.89.188.1</code>.
The packets are based on <a href="https://en.wikipedia.org/wiki/Type-length-value">Type-Length-Value (TLV)</a>.
The value is a list of TLVs.</p>
<h4 id="packet-structure"><a class="header" href="#packet-structure">Packet Structure</a></h4>
<table><thead><tr><th>Offset</th><th>Size</th><th>Name</th></tr></thead><tbody>
<tr><td>0</td><td>u8</td><td>Packet version</td></tr>
<tr><td>1</td><td>u8</td><td>Type</td></tr>
<tr><td>2-3</td><td>u16</td><td>Length</td></tr>
<tr><td>4</td><td>[u8]</td><td>Value</td></tr>
</tbody></table>
<p>There are currently two (maybe three?) packet versions. At the moment this document is only covering version 2.</p>
<h4 id="packet-value-types"><a class="header" href="#packet-value-types">Packet Value Types</a></h4>
<table><thead><tr><th>Type</th><th>Name</th><th>Content</th></tr></thead><tbody>
<tr><td><code>0x01</code></td><td>HardwareAddress</td><td>[u8; 6]</td></tr>
<tr><td><code>0x02</code></td><td>IpInfo</td><td>HardwareAddress([u8; 6]), IPv4([u8; 4])</td></tr>
<tr><td><code>0x03</code></td><td>FirmwareVersion</td><td>String</td></tr>
<tr><td><code>0x04</code></td><td><em>Unknown</em></td><td><em>Unknown</em></td></tr>
<tr><td><code>0x05</code></td><td><em>Unknown</em></td><td><em>Unknown</em></td></tr>
<tr><td><code>0x06</code></td><td>Username</td><td>String</td></tr>
<tr><td><code>0x07</code></td><td>Salt</td><td>[u8]</td></tr>
<tr><td><code>0x08</code></td><td>Challenge</td><td>[u8]</td></tr>
<tr><td><code>0x09</code></td><td><em>Unknown</em></td><td><em>Unknown</em></td></tr>
<tr><td><code>0x0A</code></td><td>Uptime</td><td>i64</td></tr>
<tr><td><code>0x0B</code></td><td>Hostname</td><td>String</td></tr>
<tr><td><code>0x0C</code></td><td>Platform</td><td>String</td></tr>
<tr><td><code>0x0D</code></td><td>ESSID</td><td>String</td></tr>
<tr><td><code>0x0E</code></td><td>WMode</td><td>i32</td></tr>
<tr><td><code>0x0F</code></td><td><em>Unknown</em></td><td><em>Unknown</em></td></tr>
<tr><td><code>0x10</code></td><td><em>Unknown</em></td><td>String</td></tr>
<tr><td><code>0x11</code></td><td><em>Unknown</em></td><td><em>Unknown</em></td></tr>
<tr><td><code>0x12</code></td><td>Sequence *</td><td>i32</td></tr>
<tr><td><code>0x13</code></td><td>Serial **</td><td>String</td></tr>
<tr><td><code>0x14</code></td><td><em>Unknown</em></td><td><em>Unknown</em></td></tr>
<tr><td><code>0x15</code></td><td>Model</td><td>String</td></tr>
<tr><td><code>0x16</code></td><td>MinimumControllerVersion</td><td>String</td></tr>
<tr><td><code>0x17</code></td><td>IsDefault</td><td>bool</td></tr>
<tr><td><code>0x18</code></td><td><em>Unknown</em></td><td>bool</td></tr>
<tr><td><code>0x19</code></td><td><em>Unknown</em></td><td>bool</td></tr>
<tr><td><code>0x1A</code></td><td><em>Unknown</em></td><td>bool</td></tr>
<tr><td><code>0x1B</code></td><td>Version</td><td>String</td></tr>
<tr><td><code>0x1C</code></td><td><em>Unknown</em></td><td>i32</td></tr>
<tr><td><code>0x1D</code></td><td><em>Unknown</em></td><td>String</td></tr>
</tbody></table>
<p>* <em>Sequence is an incrementing number</em> <br />
** <em>Serial is usually the hardware address without any separators</em></p>
<h1 id="inform-protocol"><a class="header" href="#inform-protocol">Inform Protocol</a></h1>
<p>UniFi devices communicate to their controller via HTTP POST as <code>application/x-binary</code> containing it's current status every ~10 seconds to the <code>inform URL</code>.
The <code>inform URL</code> defaults to <code>http://unifi:8080/inform</code> but may be set to the controller's IP address.
A controller will respond with either a no-op and an interval for the next inform or command for the device to execute.
A UniFi device will execute commands and send another inform packet.
Requests and responses share the same format encoded in big endian byte order.
When reading, inform packets are decrypted before decompression, inverse is true for writing.
There is currently only one payload version. Payload version 1 is JSON content and is the current version.</p>
<h2 id="encryptiondecryption"><a class="header" href="#encryptiondecryption">Encryption/Decryption</a></h2>
<p>There are two possible ciphers used to encrypt the inform payload.
Although you can send the controller plain-text, it will not respond to non-encrypted payloads.
<code>AES-CBC</code> is used, and is the default, if the <code>1st-bit</code> is set on the flag, or <code>AES-GCM</code> if the <code>1st-bit</code> and <code>4th-bit</code> are set.
The Initialization Vector is 16 bytes in length and is sent in the header.
The default encryption <code>authkey</code> is the MD5 hash of <code>ubnt</code> (<code>ba86f2bbe107c7c57eb5f2690775c712</code>).
When decrypting <code>AES-GCM</code> the first 40 bytes of the packet is used as the additional authenticated data (AAD) and the last 16 bytes of the payload is the tag.</p>
<h2 id="compressiondecompression"><a class="header" href="#compressiondecompression">Compression/Decompression</a></h2>
<p>There are two possible compression modes used at the moment.
The default method is <a href="https://en.wikipedia.org/wiki/Zlib">ZLib</a> and uses the <code>2nd-bit</code> of the flag.
<a href="https://en.wikipedia.org/wiki/Snappy_(compression)">Snappy</a> is another possible compression method and uses the <code>3rd-bit</code>.</p>
<h2 id="packet-structure-1"><a class="header" href="#packet-structure-1">Packet Structure</a></h2>
<table><thead><tr><th>Offset</th><th>Size</th><th>Name</th></tr></thead><tbody>
<tr><td>0-3</td><td>u32</td><td>Magic Header (<code>TNBU</code> or <code>1414414933</code>)</td></tr>
<tr><td>4-7</td><td>u32</td><td>Packet Version</td></tr>
<tr><td>8-13</td><td>[u8; 6]</td><td>Hardware Address</td></tr>
<tr><td>14-15</td><td>u16</td><td><a href="protocols/inform.html#flags">Flags</a></td></tr>
<tr><td>16-31</td><td>[u8; 16]</td><td>Initialization Vector for encryption</td></tr>
<tr><td>32-35</td><td>u32</td><td>Payload Version</td></tr>
<tr><td>36-39</td><td>u32</td><td>Payload Length</td></tr>
<tr><td>40-n</td><td>[u8]</td><td><a href="protocols/./inform-json-payload.html#inform-protocol-json-payload">Payload</a></td></tr>
</tbody></table>
<h3 id="flags"><a class="header" href="#flags">Flags</a></h3>
<table><thead><tr><th>Value</th><th>Bits</th><th>Name</th></tr></thead><tbody>
<tr><td><code>0x01</code></td><td><code>0b0000000000000001</code></td><td>Encrypted</td></tr>
<tr><td><code>0x02</code></td><td><code>0b0000000000000010</code></td><td>ZLibCompressed</td></tr>
<tr><td><code>0x04</code></td><td><code>0b0000000000000100</code></td><td>SnappyCompressed</td></tr>
<tr><td><code>0x08</code></td><td><code>0b0000000000001000</code></td><td>EncryptedGCM</td></tr>
</tbody></table>
<h1 id="inform-protocol-json-payload"><a class="header" href="#inform-protocol-json-payload">Inform Protocol JSON Payload</a></h1>
<p># TODO: Write about the inform JSON payload content, there is a lot here...</p>
<h3 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h3>
<ul>
<li><a href="protocols/inform-json-payload.html#command-payloads">Command Payloads</a></li>
</ul>
<h2 id="command-payloads"><a class="header" href="#command-payloads">Command Payloads</a></h2>
<p>There are six command types at the moment.</p>
<table><thead><tr><th>Name</th><th>Type</th></tr></thead><tbody>
<tr><td>_type</td><td>String: <a href="protocols/inform-json-payload.html#inform-command-type">Inform Command Type</a></td></tr>
<tr><td>use_alert</td><td>bool</td></tr>
<tr><td>device_id</td><td>String</td></tr>
<tr><td>datetime</td><td>String</td></tr>
<tr><td>time</td><td>u64</td></tr>
<tr><td>cmd</td><td>String</td></tr>
<tr><td><a href="protocols/../config/management.html">mgmt_cfg</a></td><td>String</td></tr>
<tr><td><a href="protocols/../config/system.html">system_cfg</a></td><td>String</td></tr>
<tr><td>md5sum</td><td>String</td></tr>
<tr><td>url</td><td>String</td></tr>
<tr><td>version</td><td>String</td></tr>
<tr><td>interval</td><td>u64</td></tr>
<tr><td>server_time_in_utc</td><td>String</td></tr>
</tbody></table>
<h3 id="inform-command-type"><a class="header" href="#inform-command-type">Inform Command Type</a></h3>
<table><thead><tr><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>noop</td><td>Do nothing</td></tr>
<tr><td>setparam</td><td>Update a config (<a href="protocols/../config/management.html">mgmt_cfg</a> / <a href="protocols/../config/system.html">system_cfg</a>)</td></tr>
<tr><td>upgrade</td><td>Upgrade the device using the firmware file located at <code>url</code></td></tr>
<tr><td>reboot</td><td>Reboot the device</td></tr>
<tr><td>cmd</td><td>Run a <code>cmd</code></td></tr>
<tr><td>setdefault</td><td>Factory reset the device</td></tr>
</tbody></table>
<h1 id="adoption"><a class="header" href="#adoption">Adoption</a></h1>
<p><a href="https://help.ubnt.com/hc/en-us/articles/204909754-UniFi-Device-Adoption-Methods-for-Remote-UniFi-Controllers">Official documentation for UniFi adoption methods</a></p>
<h2 id="layer-2-adoption"><a class="header" href="#layer-2-adoption">Layer 2 Adoption</a></h2>
<p>UniFi adopts devices within the layer 2 network via an SSH remote command to assign the <code>authkey</code> used for <a href="./protocols/inform.html#encryptiondecryption">inform encryption</a>.
The controller will send <code>/usr/bin/syswrapper.sh set-adopt &lt;inform_url&gt; &lt;authkey&gt;</code> to the device using the default username and password of <code>ubnt</code>:<code>ubnt</code>.</p>
<h2 id="layer-3-adoption"><a class="header" href="#layer-3-adoption">Layer 3 Adoption</a></h2>
<p>Layer 3 adoption works by having a new device reach out with an inform packet to a 'remote' controller over HTTP POST using the default <code>authkey</code>.
The new device will show as <code>Pending Adoption</code> in the UniFi controller UI until an operator adopts the device.</p>
<h2 id="adoption-process"><a class="header" href="#adoption-process">Adoption Process</a></h2>
<p>On the first inform packet during adoption the controller will respond with a <code>setparam</code> command that will set the device's unique <code>authkey</code> as well as other config settings.
The second response will provision the device and contain the device's configuration.</p>
<h1 id="config"><a class="header" href="#config">Config</a></h1>
<p>This section documents what I've learned about how the UniFi configuration is structured.</p>
<ul>
<li><a href="./config/management.html">Management</a></li>
<li><a href="./config/system.html">System</a></li>
</ul>
<h1 id="management-config"><a class="header" href="#management-config">Management Config</a></h1>
<p># TODO: Write about the management configuration.</p>
<h1 id="system-config"><a class="header" href="#system-config">System Config</a></h1>
<p># TODO: Write about the system configuration.</p>
<h1 id="previous-works-of-others"><a class="header" href="#previous-works-of-others">Previous works of others</a></h1>
<ul>
<li><a href="https://github.com/jk-5/unifi-inform-protocol">jk-5/unifi-inform-protocol</a></li>
<li><a href="https://github.com/fxkr/unifi-protocol-reverse-engineering">fxkr/unifi-protocol-reverse-engineering</a></li>
<li><a href="https://github.com/crc32/unifi-gateway">crc32/unifi-gateway</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
